<dom-module id="vaadin-grid-sorter">
  <template>
    <style>
      :host {
        display: inline-flex;
        cursor: pointer;
      }

      #indicator[direction=desc] {
        transform: rotateZ(180deg);
      }

      [direction=""] {
        color: lightgray;
      }
    </style>

    <content></content>
    <content select=".sort-indicator">
      <div id="indicator" direction$="[[direction]]">^</div><div direction$="[[direction]]">([[order]])</div>
    </content>
  </template>
  <script>
    Polymer({
      is: 'vaadin-grid-sorter',

      properties: {

        _grid: Object,

        _cell: Object,

        path: String,

        direction: String,

        order: Number

      },

      observers: [
        '_parametersChanged(_grid, path, direction)'
      ],

      ready: function() {
        this._initialOrder = this.order;
      },

      attached: function() {
        this._grid = this._getAncestor('vaadin-grid', this.parentNode);
        this._cell = this._getAncestor('th, td', this.parentNode);
        this.listen(this._cell, 'cell-click', '_onClick');
      },

      detached: function() {
        this.unlisten(this._cell, 'cell-click', '_onClick');
      },

      _parametersChanged: function(grid, path, direction) {
        var sorters = this._grid._sorters;

        if (this._initialOrder !== undefined) {
          sorters.push(this);

          var getOrder = function(sorter) {
            return sorter._initialOrder !== undefined ? sorter._initialOrder : sorter.order;
          };
          sorters.sort(function(a, b) {
            return getOrder(a) - getOrder(b);
          });

          this._initialOrder = undefined;
        } else {
          this._removeItem(sorters, this);
          if (this.direction) {
            sorters.unshift(this);
          }

          this.order = null;
          sorters.forEach(function(sorter, index) {
            sorter.order = index + 1;
          });
        }

        grid.clearCache();
      },

      _removeItem: function(array, item) {
        var index = array.indexOf(item);
        if (index > -1) {
          array.splice(index, 1);
        }
      },

      _onClick: function(e) {
        if (Polymer.dom(e).path.indexOf(this) === -1) {
          //TODO: Should not invoke when the sorter isn't clicked (but some other element in the cell)
        }


        if (this.direction === 'desc') {
          this.direction = 'asc';
        } else if (this.direction === 'asc') {
          this.direction = '';
        } else {
          this.direction = 'desc';
        }
      },

      _getAncestor: function(matcher, node) {
        if (node) {
          if (node.matches && node.matches(matcher)) {
            return node;
          }
          return this._getAncestor(matcher, node.parentNode);
        }
      }

    });
  </script>
</dom-module>

<script>
  window.vaadin = window.vaadin || {};
  vaadin.elements = vaadin.elements || {};
  vaadin.elements.grid = vaadin.elements.grid || {};

  vaadin.elements.grid.SortBehavior = {

    properties: {

      _sorters: {
        type: Array,
        value: function() {
          return [];
        }
      }

    }

  };
</script>
